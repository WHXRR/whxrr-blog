---
title: "ç€‘å¸ƒæµ + è™šæ‹Ÿåˆ—è¡¨å®ç°ä¸å®šé«˜åšå®¢åˆ—è¡¨"
outline: deep
desc: "å¦‚ä½•ä¼˜é›…åœ°æŠŠä¸€å †é«˜åº¦ä¸ä¸€çš„å¡ç‰‡æ‘†å¾—æ•´æ•´é½é½ï¼Œè¿˜ä¸è®©æµè§ˆå™¨ç´¯ç˜«ï¼Ÿè¯•è¯•ç€‘å¸ƒæµ + è™šæ‹Ÿæ»šåŠ¨ï¼"
tags: "ç€‘å¸ƒæµ|è™šæ‹Ÿåˆ—è¡¨"
updateTime: "2025-06-18 09:18"
pic: https://public.ysjf.com/mediastorm/material/material/%E8%A5%BF%E6%B2%83%E5%BE%B7-%E5%93%88%E8%8B%8F%E7%85%A7%E7%89%87-02-%E5%85%A8%E6%99%AF-20250107.JPG
picSize: 689x919
---

## å¼€å§‹ ğŸš€

æˆ‘è¿™é‡Œä½¿ç”¨ vue3 å®ç°ç€‘å¸ƒæµ+è™šæ‹Ÿåˆ—è¡¨ï¼Œå®ç°æ•ˆæœå¯ä»¥çœ‹è¿™é‡Œã€‚

[æ–‡ç« åˆ—è¡¨](/blogs)

## ä»€ä¹ˆæ˜¯ç€‘å¸ƒæµï¼ŸğŸŒŠ

ä»€ä¹ˆæ˜¯ç€‘å¸ƒæµï¼Œç€‘å¸ƒæµæ˜¯ä¸€ç§å¸¸ç”¨äºå±•ç¤ºä¸ç­‰é«˜å†…å®¹å—çš„ç½‘é¡µå¸ƒå±€æ–¹å¼ï¼Œå…¶ç‰¹ç‚¹æ˜¯ï¼š

> **ä»ä¸Šå¾€ä¸‹å¡«å……ï¼Œä¼˜å…ˆæ”¾åˆ°å½“å‰æœ€çŸ­çš„é‚£ä¸€åˆ—ã€‚**

åƒä¸‹é¢å°çº¢ä¹¦è¿™æ ·

![å°çº¢ä¹¦é¦–é¡µ](/notes/ç€‘å¸ƒæµ/1.jpg)

### css å®ç° ğŸ¨

é¦–å…ˆçº¯ css å°±å¯ä»¥å®ç°ç±»ä¼¼ä¸Šé¢çš„æ•ˆæœï¼Œå¦‚ä¸‹é¢çš„ä»£ç 

```html
<div class="p-10 columns-3 lg:columns-5">
  <div class="h-[100px] bg-red-100 break-inside-avoid mb-4">1</div>
  <div class="h-[120px] bg-blue-100 break-inside-avoid mb-4">2</div>
  <div class="h-[50px] bg-slate-200 break-inside-avoid mb-4">3</div>
  <div class="h-[90px] bg-orange-200 break-inside-avoid mb-4">4</div>
  <div class="h-[40px] bg-yellow-100 break-inside-avoid mb-4">5</div>
  <div class="h-[180px] bg-pink-100 break-inside-avoid mb-4">6</div>
  <div class="h-[180px] bg-gray-100 break-inside-avoid mb-4">7</div>
</div>
```

![cssç€‘å¸ƒæµ](/notes/ç€‘å¸ƒæµ/2.jpg)

è¿™ç§æ–¹å¼è™½ç„¶ç®€å•ç›´è§‚ï¼Œä½†å®ƒæ˜¯â€œåˆ—ä¼˜å…ˆâ€å¡«å……ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬é¢„æœŸä¸­çš„â€œé«˜åº¦æœ€çŸ­åˆ—ä¼˜å…ˆâ€ã€‚æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦æ›´ç²¾å‡†æ§åˆ¶ï¼ˆæ¯”å¦‚é…åˆè™šæ‹Ÿåˆ—è¡¨ï¼‰æ—¶ï¼ŒCSS æ–¹å¼å°±ä¸å¤ªå¤Ÿç”¨äº†ã€‚ğŸ™…â€â™‚ï¸

### js å®ç° ğŸ§©

æˆ‘ä»¬é€šè¿‡ JavaScript æ¥å®ç°æ›´çµæ´»ã€å¯æ§çš„ç€‘å¸ƒæµå¸ƒå±€ã€‚æ ¸å¿ƒé€»è¾‘ï¼š

- è·å–å®¹å™¨å®½åº¦ï¼Œè®¡ç®—æ¯ä¸ªå¡ç‰‡å®½åº¦ï¼›
- é€šè¿‡å“åº”å¼æ–­ç‚¹é€‚é…ä¸åŒåˆ—æ•°ï¼›
- æ ¹æ®å›¾ç‰‡å®½é«˜æ¯” & æ–‡æœ¬å†…å®¹åŠ¨æ€è®¡ç®—å¡ç‰‡é«˜åº¦ï¼›
- æ¯å¼ å¡ç‰‡æ’å…¥å½“å‰â€œæœ€çŸ­â€çš„åˆ—ä¸­ï¼›
- ç”¨ `transform` è¿›è¡Œç»å¯¹å®šä½ï¼Œæ€§èƒ½æ›´ä¼˜ï¼›

#### å¸ƒå±€

å¸ƒå±€æˆ‘ä»¬åˆ†ä¸ºå®¹å™¨ï¼Œåˆ—è¡¨ï¼Œåˆ—è¡¨é¡¹ä¸‰ä¸ªéƒ¨åˆ†

```html
<div
  class="waterfall-container w-full h-full overflow-x-hidden overflow-y-auto"
>
  <div class="waterfall-list relative">
    <div
      class="waterfall-item absolute top-0 left-0 transition-transform duration-300 overflow-hidden will-change-transform"
    >
      <slot :item="item"></slot>
    </div>
  </div>
</div>
```

> [!TIP]
> container éƒ¨åˆ†è¦è®¾ç½®è¶…å‡ºæ»šåŠ¨ï¼Œå­é¡¹é€šè¿‡ç»å¯¹å®šä½ç»Ÿä¸€åœ¨å·¦ä¸Šè§’ï¼Œåé¢é€šè¿‡ translate3d æ¥å®ç°åç§»ï¼Œå†è®¾ç½®æ’æ§½æ¥æ˜¾ç¤ºå†…å®¹ã€‚

#### å‚æ•°å®šä¹‰

- å› ä¸ºæˆ‘ä»¬æ˜¯å°è£…çš„ç»„ä»¶ï¼Œæ‰€ä»¥è¦é…ç½®ä¸€äº›å‚æ•°è®©ç”¨æˆ·ä¼ å…¥ã€‚

```ts
interface IItem {
  id: number;
  url: string;
  date: Record<string, any>;
  frontmatter: Record<string, any>;
}
interface IBreakpoint {
  [key: string]: {
    columns: number;
    gap: number;
  };
}
const props = defineProps<{
  list: IItem[];
  gap: number;
  columns: number;
  breakPoint?: IBreakpoint;
}>();
```

> [!TIP]
> list æ˜¯åˆ—è¡¨æ•°æ®ï¼Œè¿™é‡Œçš„ id è¦è®¾ç½®åˆ—è¡¨çš„ç´¢å¼•å€¼ï¼Œåé¢å–æ•°æ®æ—¶è¦ç”¨åˆ°ã€‚gap æ˜¯åˆ—è¡¨é¡¹ä¹‹é—´çš„é—´è·ï¼Œcolumns æ˜¯åˆ—æ•°ï¼ŒbreakPoint æ˜¯å“åº”å¼çš„é…ç½®ï¼Œå½“å±å¹•å®½åº¦å°äºæŸä¸ªå€¼æ—¶ï¼Œåˆ—æ•°ä¼šæ”¹å˜ã€‚

- ç„¶åæ˜¯å®šä¹‰ä¸€äº›å˜é‡ï¼Œç”¨æ¥å­˜å‚¨å¡ç‰‡çš„æ•°æ®å’Œæ¯ä¸€åˆ—çš„é«˜åº¦ã€‚

```ts
interface ICardPosition {
  imageHeight: number;
  width: number;
  height: number;
  x: number;
  y: number;
}
const state = reactive({
  cardWidth: 0,
  cardPosition: [] as ICardPosition[],
  columnHeight: [] as number[],
});
```

> [!TIP]
> cardWidth æ˜¯å¡ç‰‡çš„å®½åº¦ï¼ŒcardPosition å­˜å‚¨è¿™å¡ç‰‡çš„å›¾ç‰‡é«˜åº¦ï¼Œå¡ç‰‡å®½é«˜å’Œ xï¼Œy çš„åç§»é‡ï¼ŒcolumnHeight æ˜¯æ¯ä¸€åˆ—çš„é«˜åº¦ã€‚

#### è·å–åˆ—æ•°å’Œé—´è·

å› ä¸ºæˆ‘ä»¬æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥è¦æ ¹æ®å±å¹•å®½åº¦æ¥è·å–ç”¨æˆ·ä¼ å…¥çš„æ­£ç¡®çš„åˆ—æ•°å’Œé—´è·ã€‚

```ts
const breakPoint = {
  560: {
    columns: 3,
    gap: 10,
  },
  1024: {
    columns: 4,
    gap: 20,
  },
  1280: {
    columns: 5,
    gap: 20,
  },
};
```

é€šè¿‡å¾ªç¯åˆ¤æ–­è·å–æ­£ç¡®çš„åˆ—æ•°å’Œé—´è·ã€‚

```ts
const realColumnsAndGap = reactive({
  columns: props.columns,
  gap: props.gap,
});
const calculateColumnsAndGap = () => {
  const breakpoints = props.breakPoint;
  const windowWidth = window.innerWidth;
  let matched = {
    columns: props.columns,
    gap: props.gap,
  };
  let maxMatchedWidth = -1;
  if (breakpoints) {
    Object.keys(breakpoints).forEach((bp) => {
      const bpNum = Number(bp);
      if (windowWidth >= bpNum && bpNum > maxMatchedWidth) {
        maxMatchedWidth = bpNum;
        matched = breakpoints[bpNum];
      }
    });
  }
  if (matched) {
    realColumnsAndGap.columns = matched.columns;
    realColumnsAndGap.gap = matched.gap;
  } else {
    realColumnsAndGap.columns = props.columns;
    realColumnsAndGap.gap = props.gap;
  }
};
```

å¦‚æœæ²¡ä¼ å“åº”å¼é…ç½®åˆ™ç”¨é»˜è®¤çš„ columns å’Œ gapã€‚

#### è®¡ç®—å¡ç‰‡çš„å®½åº¦

è·å–åˆ°åˆ—æ•°å’Œé—´è·åï¼Œå°±å¯ä»¥é€šè¿‡å®¹å™¨çš„å®½åº¦æ¥è®¡ç®—å¡ç‰‡çš„å®½åº¦äº†ã€‚

è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸ª ref ç»‘å®š container

```ts
const containerRef = ref<HTMLDivElement | null>(null);
const calculateCardWidth = () => {
  if (!containerRef.value) return;
  const containerWidth = containerRef.value.clientWidth;
  state.cardWidth =
    (containerWidth - realColumnsAndGap.gap * (realColumnsAndGap.columns - 1)) /
    realColumnsAndGap.columns;
};
```

> [!TIP]
> gap çš„æ•°é‡æ˜¯ columns - 1

#### è®¡ç®—å›¾ç‰‡é«˜åº¦

è¿™é‡Œçš„å›¾ç‰‡å®½é«˜ä¿¡æ¯è¦é€šè¿‡åç«¯è¿”å›ï¼Œä¸ç„¶åªèƒ½é€šè¿‡å‰ç«¯é¢„åŠ è½½æ¥è·å–ï¼Œä½†æ˜¯å¯¹äºå›¾ç‰‡å¤šçš„æ¥è¯´ï¼Œè¿™æ ·éå¸¸è€—æ—¶é—´ã€‚

```ts
const calculateCardImageHeight = () => {
  list.value.forEach((item, index) => {
    if (!item.frontmatter.pic) return;
    const [width, height] = item.frontmatter.picSize.split("x");
    const imageHeight = Math.floor((state.cardWidth * height) / width);
    state.cardPosition[index] = {
      ...state.cardPosition[index],
      imageHeight,
    };
  });
};
```

#### è®¡ç®—å¡ç‰‡é«˜åº¦

é¦–å…ˆæˆ‘ä»¬åˆ†æä¸‹å°çº¢ä¹¦çš„å¸ƒå±€ï¼Œåˆ†ä¸ºå›¾ç‰‡ã€æ ‡é¢˜ã€å’Œä½œè€…ä¿¡æ¯ã€‚

è¿™é‡Œå›¾ç‰‡çš„é«˜åº¦æˆ‘ä»¬çŸ¥é“äº†ï¼Œä½œè€…ä¿¡æ¯çš„é«˜åº¦é€šè¿‡å…ƒç´ é€‰æ‹©æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯å›ºå®šçš„ 20pxï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¡ç®—æ ‡é¢˜çš„é«˜åº¦å°±å¯ä»¥äº†ã€‚

å°çº¢ä¹¦è¿™é‡Œæ ‡é¢˜åˆ†ä¸ºä¸€è¡Œè·Ÿä¸¤è¡Œï¼Œæˆ‘ä»¬é€šè¿‡ canvas çš„ [measureText](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/measureText) å¯ä»¥è·å–æ–‡æœ¬çš„å®½åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿™ä¸ªå®½åº¦è·Ÿå¡ç‰‡çš„å®½åº¦æ¯”è¾ƒï¼Œå¦‚æœè¶…è¿‡å¡ç‰‡çš„å®½åº¦å°±è¡¨ç¤ºæ–‡æœ¬ä¼šæ¢è¡Œæ˜¾ç¤ºï¼Œç›´æ¥å–ä¸¤è¡Œçš„é«˜åº¦å³å¯ã€‚

æˆ‘çš„æ–‡ç« åˆ—è¡¨ä¹Ÿç±»ä¼¼å°çº¢ä¹¦çš„å¸ƒå±€ï¼Œåˆ†ä¸ºå›¾ç‰‡ã€æ ‡é¢˜ã€ç®€ä»‹å’Œå‘å¸ƒæ—¶é—´ã€‚

![æ–‡ç« åˆ—è¡¨](/notes/ç€‘å¸ƒæµ/3.jpg)

å†…å®¹åŒºåŸŸçš„è¾¹è·ï¼Œæ ‡é¢˜é«˜åº¦ï¼Œå‘å¸ƒæ—¶é—´é«˜åº¦æ˜¯å›ºå®šçš„ï¼Œä¸€è¡Œç®€ä»‹è·Ÿä¸¤è¡Œç®€ä»‹çš„é«˜åº¦ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå®šä¹‰å¥½å˜é‡ã€‚

```ts
const padding = 24;
const titleHeight = 20;
const oneRowContent = 22;
const twoRowContent = 38;
const timeHeight = 28;
```

é¦–å…ˆå®šä¹‰ä¸€ä¸ªéšè—çš„ canvasï¼Œç”¨æ¥æµ‹é‡æ–‡æœ¬çš„å®½åº¦

```html
<canvas id="canvas" ref="canvasRef" class="hidden"></canvas>
```

æ¥ç€å°±å¯ä»¥è®¡ç®—æ–‡æœ¬å®½åº¦

```ts
const canvasRef = ref<HTMLCanvasElement | null>(null);
const getTextWidth = (text: string) => {
  if (!canvasRef.value || !containerRef.value) return 0;
  const ctx = canvasRef.value.getContext("2d");
  if (!ctx) return 0;
  const style = getComputedStyle(containerRef.value);
  ctx.font = `12px ${style.fontFamily}`;
  const canvasText = ctx.measureText(text);
  return canvasText.width;
};
```

> [!TIP]
> è¿™é‡Œéœ€è¦æ³¨æ„è®¾ç½® canvas çš„å­—ä½“æ ·å¼ï¼Œæˆ‘çš„æ ‡é¢˜æ˜¯ç”¨çš„ 12px çš„å­—ä½“å¤§å°ï¼Œå­—ä½“ç”¨çš„é»˜è®¤å­—ä½“ã€‚

è·å–å¡ç‰‡é«˜åº¦

```ts
const getCardHeight = () => {
  list.value.forEach((item, index) => {
    const padding = 24;
    const titleHeight = 20;
    const oneRowContent = 22;
    const twoRowContent = 38;
    const timeHeight = 28;
    const contentWidth = getTextWidth(item.frontmatter.desc);
    const contentHeight =
      contentWidth > state.cardWidth - 16 ? twoRowContent : oneRowContent;
    const cardHeight =
      padding +
      titleHeight +
      contentHeight +
      timeHeight +
      state.cardPosition[index].imageHeight;
  });
};
```

è·å–åˆ°å¡ç‰‡çš„é«˜åº¦ä¿¡æ¯åï¼Œæˆ‘ä»¬éœ€è¦å°†ä¿¡æ¯æ·»åŠ åˆ°ä¸Šé¢å®šä¹‰çš„ state.cardPosition ä¸­ï¼ŒåŒæ—¶å°†ä¿¡æ¯åŠ å…¥ state.columnHeight ä¸­ï¼Œæ–¹ä¾¿åé¢è®¡ç®—å¡ç‰‡çš„ä½ç½®ã€‚
æˆ‘ä»¬çŸ¥é“ç€‘å¸ƒæµçš„å¸ƒå±€ç¬¬ä¸€æ’éƒ½æ˜¯åœ¨æœ€é¡¶ä¸Šï¼Œä»ç¬¬äºŒæ’å¼€å§‹ï¼Œæ¯ä¸ªå¡ç‰‡åœ¨æ’å…¥æ—¶ï¼Œè¦æ’å…¥æœ€å°é«˜åº¦çš„é‚£ä¸€åˆ—ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µã€‚

- ç¬¬ä¸€æ’æ—¶

```ts
if (index < realColumnsAndGap.columns) {
  state.cardPosition[index] = {
    ...state.cardPosition[index],
    width: state.cardWidth,
    height: cardHeight,
    x:
      index % realColumnsAndGap.columns === 0
        ? 0
        : index * (state.cardWidth + realColumnsAndGap.gap),
    y: 0,
  };
  state.columnHeight[index] = cardHeight + realColumnsAndGap.gap;
}
```

> [!TIP]
> å½“æ˜¯æœ€å·¦è¾¹ä¸€ä¸ªçš„æ—¶å€™ï¼Œx çš„å€¼ä¸º 0ï¼Œå¦åˆ™ä¸ºå½“å‰åˆ—æ•°ä¹˜ä»¥å¡ç‰‡å®½åº¦åŠ ä¸Šé—´è·ã€‚

- ä¸æ˜¯ç¬¬ä¸€æ’
  ä¸æ˜¯ç¬¬ä¸€æ’çš„æ—¶å€™æˆ‘ä»¬è¦è·å–æœ€å°é«˜åº¦çš„åˆ—å’Œå¯¹åº”çš„ç´¢å¼•å€¼ã€‚å› ä¸ºåé¢éœ€è¦å°†é«˜åº¦æœ€å¤§çš„é‚£ä¸€åˆ—çš„å€¼ç»‘å®šåˆ°åˆ—è¡¨çš„é«˜åº¦ä¸Šï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç”¨æ¥è·å–æœ€å¤§å’Œæœ€å°é«˜åº¦åˆ—çš„å‡½æ•°ã€‚

```ts
const columnStats = computed(() => {
  let minIndex = -1;
  let minHeight = 0;
  let maxHeight = 0;

  state.columnHeight.forEach((height, index) => {
    // å¤„ç†æœ€å°å€¼
    if (minIndex === -1 || height < minHeight) {
      minIndex = index;
      minHeight = height;
    }

    // å¤„ç†æœ€å¤§å€¼
    if (height > maxHeight) {
      maxHeight = height;
    }
  });

  return {
    minIndex,
    minHeight,
    maxHeight,
  };
});
```

ç”¨è·å–åˆ°çš„æœ€å°é«˜åº¦åˆ—çš„ç´¢å¼•å€¼æ¥æ›¿æ¢ indexï¼Œå’Œ yã€‚

```ts
const { minIndex, minHeight } = columnStats.value;
state.cardPosition[index] = {
  ...state.cardPosition[index],
  width: state.cardWidth,
  height: cardHeight,
  x: minIndex * (state.cardWidth + realColumnsAndGap.gap),
  y: minHeight,
};
state.columnHeight[minIndex] += cardHeight + realColumnsAndGap.gap;
```

å®Œæ•´çš„è·å–å¡ç‰‡é«˜åº¦çš„ä»£ç å¦‚ä¸‹

```ts
const getCardHeight = () => {
  list.value.forEach((item, index) => {
    const padding = 24;
    const titleHeight = 20;
    const oneRowContent = 22;
    const twoRowContent = 38;
    const timeHeight = 28;
    const contentWidth = getTextWidth(item.frontmatter.desc);
    const contentHeight =
      contentWidth > state.cardWidth - 16 ? twoRowContent : oneRowContent;
    const cardHeight =
      padding +
      titleHeight +
      contentHeight +
      timeHeight +
      state.cardPosition[index].imageHeight;

    if (index < realColumnsAndGap.columns) {
      state.cardPosition[index] = {
        ...state.cardPosition[index],
        width: state.cardWidth,
        height: cardHeight,
        x:
          index % realColumnsAndGap.columns === 0
            ? 0
            : index * (state.cardWidth + realColumnsAndGap.gap),
        y: 0,
      };
      state.columnHeight[index] = cardHeight + realColumnsAndGap.gap;
    } else {
      const { minIndex, minHeight } = columnStats.value;
      state.cardPosition[index] = {
        ...state.cardPosition[index],
        width: state.cardWidth,
        height: cardHeight,
        x: minIndex * (state.cardWidth + realColumnsAndGap.gap),
        y: minHeight,
      };
      state.columnHeight[minIndex] += cardHeight + realColumnsAndGap.gap;
    }
  });
};
```

æœ€åæˆ‘ä»¬å°†ä¸Šé¢çš„æ–¹æ³•æ•´åˆè¿› init ä¸­ç»Ÿä¸€æ‰§è¡Œï¼Œå†åŠ ç›‘å¬ä¸‹ container çš„å®½åº¦å˜åŒ–ï¼Œæ¥å®ç°å“åº”å¼ã€‚

```ts
const init = () => {
  // 1.åˆå§‹åŒ–
  state.cardWidth = 0;
  state.cardPosition = [];
  state.columnHeight = [];
  // 2.è®¡ç®—åˆ—æ•°å’Œé—´è·
  calculateColumnsAndGap();
  // 3.æ ¹æ®å®¹å™¨å®½åº¦ã€åˆ—æ•°å’Œé—´è·ï¼Œè®¡ç®—å¡ç‰‡å®½åº¦
  calculateCardWidth();
  // 4.è®¡ç®—å›¾ç‰‡é«˜åº¦
  calculateCardImageHeight();
  // 5.è®¡ç®—å¡ç‰‡é«˜åº¦
  getCardHeight();
};
```

æˆ‘ä»¬ç”¨ ResizeObserver æ¥ç›‘å¬å®¹å™¨å®½åº¦çš„å˜åŒ–ã€‚

```ts
// å› ä¸ºå®½åº¦å˜åŒ–æ˜¯å¾ˆé¢‘ç¹çš„ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªé˜²æŠ–æ¥ä¼˜åŒ–ä¸‹
const debounce = (fn, delay, immediate = false) => {
  let timer;
  return function (...args) {
    const context = this;
    if (timer) clearTimeout(timer);

    if (immediate && !timer) {
      fn.apply(context, args);
    }

    timer = setTimeout(() => {
      if (!immediate) fn.apply(context, args);
      timer = null;
    }, delay);
  };
};
const debounceInit = debounce(init, 500);
const resizeObserver = new ResizeObserver(() => {
  debounceInit();
});
```

åœ¨ onMounted ä¸­æ‰§è¡Œã€‚

```ts
onMounted(async () => {
  if (!containerRef.value) return;
  init();
  resizeObserver.observe(containerRef.value);
});
onUnmounted(() => {
  containerRef.value && resizeObserver.unobserve(containerRef.value);
});
```

æœ€åé€šè¿‡ v-for æ¸²æŸ“ï¼Œç»‘å®šä¸‹æ ·å¼ã€‚

```html
<canvas id="canvas" ref="canvasRef" class="hidden"></canvas>
<div
  class="waterfall-container w-full h-full overflow-x-hidden overflow-y-auto"
  ref="containerRef"
>
  <div
    class="waterfall-list relative"
    ref="listRef"
    :style="{ height: columnStats.maxHeight + 'px' }"
  >
    <div
      class="waterfall-item absolute top-0 left-0 transition-transform duration-300 overflow-hidden will-change-transform"
      v-for="item in list"
      :key="item.id"
      :style="{
          width: `${state.cardWidth}px`,
          height: `${state.cardPosition[item.id]?.height}px`,
          transform: `translate3d(${state.cardPosition[item.id]?.x || 0}px, ${
            state.cardPosition[item.id]?.y || 0
          }px, 0)`,
        }"
    >
      <slot :item="item"></slot>
    </div>
  </div>
</div>
```

åˆ°è¿™ç€‘å¸ƒæµçš„æ•ˆæœå°±åšå¥½äº†ï¼Œå¯ä»¥æ¥çœ‹çœ‹æ•ˆæœã€‚

![ç€‘å¸ƒæµ](/notes/ç€‘å¸ƒæµ/4.jpg)

## è™šæ‹Ÿåˆ—è¡¨ ğŸ‘€

è™šæ‹Ÿåˆ—è¡¨æ˜¯ä¸€ç§æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºé«˜æ•ˆæ¸²æŸ“å¤§é‡æ•°æ®é¡¹çš„æ»šåŠ¨åˆ—è¡¨ï¼Œå¸¸ç”¨äºå‰ç«¯å¼€å‘ä¸­ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

**åªæ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„å…ƒç´ ï¼Œé¿å…ä¸€æ¬¡æ€§å°†æ‰€æœ‰åˆ—è¡¨é¡¹éƒ½æ’å…¥ DOMã€‚**

![è™šæ‹Ÿåˆ—è¡¨](/notes/ç€‘å¸ƒæµ/5.gif)

åœ¨å‰é¢å®ç°ç€‘å¸ƒæµçš„æ—¶å€™è·å–äº†å¡ç‰‡çš„ä½ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»“åˆå®¹å™¨çš„ scrollTop å’Œä½ç½®ä¿¡æ¯ä» list ä¸­ç­›é€‰å‡ºå¯è§çš„å¡ç‰‡æ•°ç»„è¿›è¡Œæ¸²æŸ“ã€‚

![è™šæ‹Ÿåˆ—è¡¨](/notes/ç€‘å¸ƒæµ/6.jpg)

é€šè¿‡ä¸Šé¢çš„å›¾å¯ä»¥å¾—å‡ºï¼š

- å½“å¡ç‰‡çš„é«˜åº¦ h + å¡ç‰‡çš„ y å¤§äº å®¹å™¨çš„æ»šåŠ¨é«˜åº¦æ—¶ï¼Œè¯¥å¡ç‰‡åœ¨å®¹å™¨é¡¶éƒ¨çš„ä¸‹æ–¹ã€‚
- å½“å¡ç‰‡çš„ y å°äºå®¹å™¨çš„æ»šåŠ¨é«˜åº¦ + å®¹å™¨é«˜åº¦æ—¶ï¼Œè¯¥å¡ç‰‡åœ¨å®¹å™¨åº•éƒ¨ä¸Šæ–¹ã€‚

åŒæ—¶æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„å¡ç‰‡ï¼Œå³ä¸ºå¯è§çš„å¡ç‰‡ã€‚ç°åœ¨æˆ‘ä»¬å°±æ¥å°†æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„å¡ç‰‡è¿‡æ»¤å‡ºæ¥ã€‚

åŒæ—¶åŠ å…¥ä¸€æ®µç¼“å†²åŒºåŸŸï¼Œè®©æ»šåŠ¨æ›´ä¸æ»‘ï¼ˆæ¯”å¦‚ buffer é«˜åº¦æ˜¯å®¹å™¨é«˜åº¦çš„ 50%ï¼‰ã€‚

```ts
const visibleCard = ref<IItem[]>([]);
const calculateVisibleCard = () => {
  const bufferHeight = containerRef.value
    ? containerRef.value.clientHeight * 0.5
    : 0;
  const arr = list.value.filter((_, index) => {
    if (state.cardPosition[index] && containerRef.value) {
      const h = state.cardPosition[index].height;
      const y = state.cardPosition[index].y;
      const scrollTop = containerRef.value.scrollTop;
      const viewportHeight = containerRef.value.clientHeight;
      return (
        y + h > scrollTop - bufferHeight &&
        y < scrollTop + viewportHeight + bufferHeight
      );
    }
  });
  visibleCard.value = arr;
};
```

å†å°†è¿™ä¸ªæ–¹æ³•ç»‘å®šåˆ°æ»šåŠ¨äº‹ä»¶ä¸Šï¼Œè¿™é‡Œæ”¾åˆ° requestAnimationFrame ä¸­ï¼Œæ¥ä¼˜åŒ–æ€§èƒ½ã€‚

```ts
const throttleRAF = (fn) => {
  let running = false;
  return function () {
    if (running) return;
    running = true;
    requestAnimationFrame(() => {
      fn();
      running = false;
    });
  };
};
const throttledCalculateVisibleCard = throttleRAF(calculateVisibleCard);
```

æœ€å html ä¸­æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬

```html
<canvas id="canvas" ref="canvasRef" class="hidden"></canvas>
<div
  class="waterfall-container w-full h-full overflow-x-hidden overflow-y-auto"
  ref="containerRef"
  @scroll="throttledCalculateVisibleCard"
>
  <div
    class="waterfall-list relative"
    ref="listRef"
    :style="{ height: columnStats.maxHeight + 'px' }"
  >
    <div
      class="waterfall-item absolute top-0 left-0 transition-transform duration-300 overflow-hidden will-change-transform"
      v-for="item in visibleCard"
      :key="item.id"
      :style="{
          width: `${state.cardWidth}px`,
          height: `${state.cardPosition[item.id]?.height}px`,
          transform: `translate3d(${state.cardPosition[item.id]?.x || 0}px, ${
            state.cardPosition[item.id]?.y || 0
          }px, 0)`,
        }"
    >
      <div class="animate-box">
        <slot :item="item"></slot>
      </div>
    </div>
  </div>
</div>
```

è¿™é‡ŒåµŒå¥—äº†ä¸ª animate-box çš„ div ç”¨æ¥æ·»åŠ æ¸å…¥çš„åŠ¨ç”»æ•ˆæœã€‚

```css
.animate-box {
  animation: MoveAnimate 0.5s;
}
@keyframes MoveAnimate {
  from {
    opacity: 0;
    transform: translateY(200px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

æœ€åå®ç°çš„æ•ˆæœï¼Œæ³¨æ„å³ä¾§ dom çš„å˜åŒ–ã€‚

![è™šæ‹Ÿåˆ—è¡¨](/notes/ç€‘å¸ƒæµ/7.gif)
